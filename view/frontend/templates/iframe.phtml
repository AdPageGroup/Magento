<?php
declare(strict_types=1);

use Tagging\GTM\Config\Config;
use Magento\Framework\View\Element\Template;

/** @var Config $config */
/** @var Template $block */
$config = $block->getConfig();
$isHyva = isset($hyvaCsp) && $hyvaCsp;

// Get SecureHtmlRenderer using Object Manager for compatibility
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$secureRenderer = $objectManager->get(\Magento\Framework\View\Helper\SecureHtmlRenderer::class);

if ($config->isEnabled() && $config->getGoogleTagmanagerUrl() && strlen($config->getGoogleTagmanagerUrl()) > 0 && $config->isPlacedByPlugin()) :
    
    // First script - proxy domain
    $proxyScript = "window.tagging_proxy_domain = 'https://" . $config->getGoogleTagmanagerUrl() . "';";
    
    if ($isHyva): ?>
        <script><?= $proxyScript ?></script><?php $hyvaCsp->registerInlineScript() ?>
    <?php else:
        echo $secureRenderer->renderTag('script', ['type' => 'text/javascript'], $proxyScript, false);
    endif; ?>
    
    <!-- External script - no CSP needed as it's whitelisted in csp_whitelist.xml -->
    <script defer src='https://<?= $config->getGoogleTagmanagerUrl() ?>/user-data-minified.es.js'></script>
    
    <!-- Load main.js as external script using secure renderer -->
    <?php
    if ($isHyva): ?>
        <script><?= $block->getViewFileUrl('Tagging_GTM::js/main.js') ?></script><?php $hyvaCsp->registerInlineScript() ?>
    <?php else:
        echo $secureRenderer->renderTag('script', ['defer' => true, 'src' => $block->getViewFileUrl('Tagging_GTM::js/main.js')], '', false);
    endif;
endif; ?>