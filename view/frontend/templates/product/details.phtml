<?php 
declare(strict_types=1);

use Magento\Catalog\Api\Data\ProductInterface;
use Magento\Framework\View\Element\Template;
use Tagging\GTM\DataLayer\Tag\Product\CurrentProduct;
use Tagging\GTM\ViewModel\DataLayer;
use Magento\Csp\Helper\CspNonceProvider;

/** @var Template $block */
/** @var CurrentProduct $productDetails */
/** @var DataLayer $dataLayer */

$dataLayer = $block->getDataLayer();
$productDetails = $block->getProductDetails();
$product = $block->getProduct();

if ($product instanceof ProductInterface) {
    $productDetails->setProduct($product);
}

$product = $productDetails->getProduct();
$productData = $dataLayer->toJson($productDetails->merge());
$productId = $product->getId();

// Detect if we're in HyvÃ¤ context
$isHyva = isset($hyvaCsp) && $hyvaCsp;

// Get CSP nonce provider for modern CSP compliance
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$cspNonceProvider = $objectManager->get(CspNonceProvider::class);
$nonce = $cspNonceProvider->generateNonce();

// Fallback to SecureHtmlRenderer for compatibility
$secureRenderer = $objectManager->get(\Magento\Framework\View\Helper\SecureHtmlRenderer::class);

// Build the script content
$scriptContent = "window['Tagging_GTM_PRODUCT_DATA_ID_{$productId}'] = {$productData};";

// Render based on context
if ($isHyva): ?>
    <script><?= $scriptContent ?></script><?php $hyvaCsp->registerInlineScript() ?>
<?php else: ?>
    <script nonce="<?= $nonce ?>"><?= $scriptContent ?></script>
<?php endif; ?>