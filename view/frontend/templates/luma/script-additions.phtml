<?php 
declare(strict_types=1);

/**
 * GoogleTagManager2 plugin for Magento
 *
 * @author      Yireo (http://www.yireo.com/)
 * @copyright   Copyright (c) 2019 Yireo (http://www.yireo.com/)
 * @license     Open Software License
 */

use Magento\Framework\View\Element\Template;
use Tagging\GTM\ViewModel\Commons;

/** @var Template $block */
/** @var Commons $commons */

$commons = $block->getCommonsViewModel();

// Get SecureHtmlRenderer using Object Manager for compatibility
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$secureRenderer = $objectManager->get(\Magento\Framework\View\Helper\SecureHtmlRenderer::class);

// Build the x-magento-init content
$scriptContent = json_encode([
    "*" => [
        "googleTagManager" => json_decode($commons->getConfigurationAsJson(), true)
    ]
], JSON_UNESCAPED_SLASHES);

echo $secureRenderer->renderTag(
    'script',
    ['type' => 'text/x-magento-init'],
    $scriptContent,
    false
);
?>