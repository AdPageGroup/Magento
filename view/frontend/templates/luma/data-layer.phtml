<?php
declare(strict_types=1);

use Magento\Framework\View\Element\Template;
use Tagging\GTM\Config\Config;
use Tagging\GTM\ViewModel\DataLayer;

/** @var DataLayer $dataLayerViewModel */
/** @var Config $config */
/** @var Template $block */

$config = $block->getConfig();
$dataLayerViewModel = $block->getDataLayerViewModel();
$dataLayerJson = $dataLayerViewModel->getDataLayerAsJson();
$dataLayerEventsJsonChunks = $dataLayerViewModel->getDataLayerEventsAsJsonChunks();

// Get SecureHtmlRenderer using Object Manager for compatibility
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$secureRenderer = $objectManager->get(\Magento\Framework\View\Helper\SecureHtmlRenderer::class);

// Build the script content dynamically
$scriptContent = "function callInitialDataLayer() {\n";
$scriptContent .= "    require(['googleTagManagerPush'], function(pusher) {\n";

foreach ($dataLayerEventsJsonChunks as $dataLayerEventsJsonChunk) {
    $scriptContent .= "        pusher(" . $dataLayerEventsJsonChunk . ", 'push (initial event) [data-layer.phtml]');\n";
}

$scriptContent .= "    });\n";
$scriptContent .= "}\n\n";

$scriptContent .= <<<SCRIPT
document.addEventListener("DOMContentLoaded", function() {
    if (window.taggingHelpers) {
        setTimeout(function() {
            callInitialDataLayer();
        }, 100); // Make sure we always sent after user_data
    } else {
        setTimeout(function() {
            if (window.taggingHelpers) {
                callInitialDataLayer();
            } else {
                console.log("taggingHelpers not available after wait, sending initial data layer anyway");
            }
        }, 750);
    }
});

require(['googleTagManagerPush'], function(pusher) {
    pusher({$dataLayerJson}, 'push (initial page) [data-layer.phtml]');
});
SCRIPT;

echo $secureRenderer->renderTag('script', ['type' => 'text/javascript'], $scriptContent, false);
?>